{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}

<h2 class="mb-4 fw-semibold text-primary sticky-top">
    Available Items
</h2>

{% if items and items|length > 0 %}

<div class="row g-4">

    {% for item in items %}
    <div class="col-sm-6 col-md-4 col-lg-3">

        <div class="card h-100 shadow-sm border-0">

                <!-- LISTING IMAGE -->
                {% if item.ImagePath %}
                    <img
                        src="{{ url_for('static', filename='uploads/' + item.ImagePath) }}"
                        class="card-img-top"
                        alt="{{ item.ListingTitle }}"
                        style="height: 180px; object-fit: cover;"
                    >
                {% else %}
                    <div
                        class="d-flex align-items-center justify-content-center bg-light"
                        style="height: 180px;"
                    >
                        <span class="text-muted small">No image</span>
                    </div>
                {% endif %}

            <div class="card-body d-flex flex-column">

                <h5 class="card-title mb-2">
                    {{ item.ListingTitle }}
                </h5>

                <p class="text-muted small mb-1">
                    {{ item.Location }}
                </p>

                <p class="fw-bold text-primary mb-2">
                    â‚±{{ item.Price }}
                </p>

                <p class="small text-muted mb-3">
                    Seller: {{ item.FirstName }} {{ item.LastName }}
                </p>

                <!-- VIEW ITEM BUTTON -->
                <button
                    class="btn btn-outline-primary mt-auto"
                    data-bs-toggle="modal"
                    data-bs-target="#viewItemModal"
                    data-url="{{ url_for('view_listing', listing_id=item.ListingID) }}"
                >
                    View Item
                </button>

            </div>

        </div>

    </div>
    {% endfor %}

</div>

{% else %}

<div class="alert alert-info">
    No items available.
</div>

{% endif %}

<!-- ================= VIEW ITEM MODAL ================= -->
<div
    class="modal fade"
    id="viewItemModal"
    tabindex="-1"
    aria-hidden="true"
>
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Item Details</h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>

            <div class="modal-body p-0">
                <!-- IFRAME (NO SRC BY DEFAULT) -->
                <iframe
                    id="viewItemFrame"
                    style="width:100%; height:80vh; border:none;"
                ></iframe>
            </div>

        </div>
    </div>
</div>

<!-- ================= MODAL SCRIPT ================= -->
<script>
    const viewItemModal = document.getElementById('viewItemModal');
    const iframe = document.getElementById('viewItemFrame');

    viewItemModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const url = button.getAttribute('data-url');
        iframe.src = url; // load /listing/<id>
    });

    viewItemModal.addEventListener('hidden.bs.modal', function () {
        iframe.src = ''; // reset iframe
    });
</script>

{% endblock %}
